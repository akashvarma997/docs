openapi: "3.1.0"
info:
  title: Athena GiftCard API
  description: |
    The Athena GiftCard API v2 provides enhanced features for browsing and purchasing digital gift cards.

    ## What's New in V2
    - **S3 Presigned URLs** for high-quality brand assets (logos, documents)
    - **Customer Details** support for invoice generation
    - **Delivery Details** for gift card recipients
    - **Distribution Channels** (Email, WhatsApp, SMS)
    - **Invoice Generation** with sequential numbering
    - **Tax Rate** information on SKUs

    ## Authentication
    All API requests require two headers:
    - `Authorization: Bearer <your_api_key>`
    - `partnerid: <your_partner_id>`

    Contact sunil.kumar@lysto.io for credentials and IP whitelisting.
  version: "2.0.0"
  contact:
    name: Athena Support
    email: sunil.kumar@lysto.io

servers:
  - url: https://distapi.athenagaming.gg/api/v2
    description: Production
  - url: https://stagedistapi.lysto.io/api/v2
    description: Staging
  - url: http://localhost:3001/api/v2
    description: Local Development

security:
  - BearerAuth: []
    PartnerId: []

tags:
  - name: Gift Cards
    description: Browse available gift card products with enhanced assets
  - name: SKUs
    description: Get gift card denominations with tax information
  - name: Purchase
    description: Purchase gift cards with delivery options
  - name: Orders
    description: Check order status with expiry dates
  - name: Wallet
    description: Check wallet balance
  - name: Invoice
    description: Generate PDF invoices

paths:
  /giftcards:
    get:
      tags:
        - Gift Cards
      summary: List Available Gift Cards
      description: |
        Returns available gift card products with enhanced asset information.

        **V2 Enhancements:**
        - S3 presigned URLs for high-quality logos (512x512)
        - Terms & Conditions documents
        - Steps to Redeem instructions
        - Asset URLs expire after 15 minutes
      operationId: listGiftCards
      parameters:
        - name: brand
          in: query
          description: Filter by brand name
          required: false
          schema:
            type: string
          example: Steam
        - name: pageNumber
          in: query
          description: Page number (0-indexed)
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
        - name: pageSize
          in: query
          description: Number of items per page
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Successful response with gift cards and assets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GiftCardsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /giftcards/{giftcard_id}/skus:
    get:
      tags:
        - SKUs
      summary: Get Gift Card SKU Details
      description: |
        Returns available denominations with enhanced details including tax rate.

        **V2 Enhancements:**
        - `tax_rate` field for GST/tax calculations
      operationId: getGiftCardSkus
      parameters:
        - name: giftcard_id
          in: path
          required: true
          description: Gift card product ID
          schema:
            type: string
          example: "56"
        - name: pageNumber
          in: query
          description: Page number (0-indexed)
          schema:
            type: integer
            default: 0
        - name: pageSize
          in: query
          description: Items per page
          schema:
            type: integer
            default: 20
            maximum: 100
      responses:
        '200':
          description: Successful response with SKUs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkusResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /giftcard/purchase:
    post:
      tags:
        - Purchase
      summary: Purchase a Gift Card
      description: |
        Places a gift card order with optional invoice generation and auto-delivery.

        **V2 Enhancements:**
        - Customer details for invoice generation
        - Delivery details for recipient information
        - Distribution channels for auto-delivery (Email, WhatsApp, SMS)
        - Expiry dates in response
        - Redeem link for recipients
      operationId: purchaseGiftCard
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseRequest'
            examples:
              basic:
                summary: Basic Purchase
                value:
                  merchant_order_request_id: "ORDER-2024-12345"
                  giftcard_id: "56"
                  sku_id: "1001"
                  quantity: 2
                  currency: "INR"
              with_customer:
                summary: Purchase with Customer Details
                value:
                  merchant_order_request_id: "ORDER-2024-12345"
                  giftcard_id: "56"
                  sku_id: "1001"
                  quantity: 2
                  currency: "INR"
                  customerDetails:
                    name: "Rohan Sharma"
                    email: "rohan.sharma@example.com"
                    phone: "+919876543210"
                    address:
                      line1: "123 MG Road"
                      city: "Mumbai"
                      state: "Maharashtra"
                      postal_code: "400001"
                      country: "India"
              with_delivery:
                summary: Purchase with Delivery
                value:
                  merchant_order_request_id: "ORDER-2024-12345"
                  giftcard_id: "56"
                  sku_id: "1001"
                  quantity: 2
                  currency: "INR"
                  customerDetails:
                    name: "Rohan Sharma"
                    email: "rohan.sharma@example.com"
                    phone: "+919876543210"
                  deliveryDetails:
                    recipient_email: "priya.kumar@example.com"
                    recipient_name: "Priya Kumar"
                    wish_message: "Happy Birthday! Enjoy your gift!"
                  customerDistributionChannels:
                    - "EMAIL"
      responses:
        '200':
          description: Purchase successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PurchaseResponse'
              examples:
                completed:
                  summary: Order Completed
                  value:
                    merchant_order_request_id: "ORDER-2024-12345"
                    order_id: "567890"
                    status: "completed"
                    encryptedgiftcodes: "a1b2c3d4e5f6..."
                    iv: "1234567890abcdef"
                    tag: "fedcba0987654321"
                    senderName: "Rohan Sharma"
                    deliveryDetails:
                      name: "Priya Kumar"
                      phoneNumber: "+919876543210"
                      email: "priya.kumar@example.com"
                    expiryDates:
                      - "2025-12-31T23:59:59.000Z"
                      - "2025-12-31T23:59:59.000Z"
                    redeemlink: "https://yourdomain.com/redeem/567890"
                processing:
                  summary: Order Processing
                  value:
                    merchant_order_request_id: "ORDER-2024-12345"
                    order_id: "567890"
                    status: "processing"
                    encryptedgiftcodes: ""
                    iv: ""
                    tag: ""
                    expiryDates: []
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          $ref: '#/components/responses/DuplicateOrder'

  /orders:
    get:
      tags:
        - Orders
      summary: Check Order Status
      description: |
        Returns the current status of an order with expiry dates and redeem link.

        Provide either `order_id` OR `merchant_order_request_id`.
      operationId: getOrderStatus
      parameters:
        - name: order_id
          in: query
          description: Internal order ID
          schema:
            type: string
        - name: merchant_order_request_id
          in: query
          description: Your order reference ID
          schema:
            type: string
      responses:
        '200':
          description: Order status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /wallet-balance:
    get:
      tags:
        - Wallet
      summary: Get Wallet Balance
      description: Returns the merchant's current wallet balance.
      operationId: getWalletBalance
      responses:
        '200':
          description: Wallet balance retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WalletBalanceResponse'
              example:
                balance: "92883.95"
                partnerName: "Acme Distribution Ltd"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /invoice:
    get:
      tags:
        - Invoice
      summary: Generate Invoice
      description: |
        Generate a PDF invoice for a completed order with sequential numbering.

        **Requirements:**
        - Order must be `completed` or `partial_completed`
        - At least one item must be delivered
        - Subsequent requests return the same invoice

        **Invoice Format:** `INV-{PARTNER_PREFIX}-{YEAR}-{SEQUENCE}`

        **URL Expiration:** Invoice URLs are valid for 24 hours
      operationId: generateInvoice
      parameters:
        - name: order_id
          in: query
          description: Internal order ID
          schema:
            type: string
          example: "567890"
        - name: merchant_order_request_id
          in: query
          description: Your order reference ID
          schema:
            type: string
          example: "ORDER-2024-12345"
      responses:
        '200':
          description: Invoice generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InvoiceResponse'
              example:
                status: 200
                invoice_url: "https://s3.amazonaws.com/invoices/INV-ACM-2024-00001.pdf?X-Amz-Algorithm=..."
                invoice_number: "INV-ACM-2024-00001"
                order_id: "567890"
                generated_at: "2024-01-15T10:30:00.000Z"
                expires_at: "2024-01-16T10:30:00.000Z"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: API key provided by Athena
    PartnerId:
      type: apiKey
      in: header
      name: partnerid
      description: Partner ID provided by Athena

  responses:
    Unauthorized:
      description: Authentication failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              type: authentication_error
              code: INVALID_CREDENTIALS
              message: Invalid partner ID or secret key
              trace_id: ath_v2_1761733373166_abc123
              retryable: false

    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            insufficient_balance:
              summary: Insufficient Balance
              value:
                error:
                  type: invalid_request_error
                  code: INSUFFICIENT_BALANCE
                  message: "Insufficient wallet balance. Available: 5000 INR, Required: 11800 INR."
                  trace_id: ath_v2_1761733373166_def456
                  retryable: false
                  meta:
                    available: 5000
                    required: 11800
                    currency: INR
            invalid_phone:
              summary: Invalid Phone Number
              value:
                error:
                  type: invalid_request_error
                  code: INVALID_PARAMETERS
                  message: One or more parameters are invalid
                  trace_id: ath_v2_1761733373166_ghi789
                  retryable: false
                  fields:
                    - param: phone
                      code: INVALID_FIELD_FORMAT
                      message: Valid Indian phone number is required

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              type: invalid_request_error
              code: ORDER_NOT_FOUND
              message: Order does not exist
              trace_id: ath_v2_1761733373166_jkl012
              retryable: false

    DuplicateOrder:
      description: Duplicate order ID
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error:
              type: invalid_request_error
              code: DUPLICATE_ORDER
              message: Order with this ID already exists
              trace_id: ath_v2_1761733373166_mno345
              retryable: false

  schemas:
    GiftCardsResponse:
      type: object
      properties:
        giftcards:
          type: array
          items:
            $ref: '#/components/schemas/GiftCard'
        pagination:
          $ref: '#/components/schemas/Pagination'

    GiftCard:
      type: object
      properties:
        id:
          type: string
          description: Unique product identifier
          example: "56"
        name:
          type: string
          description: Product name
          example: "Steam Voucher code"
        description:
          type: string
          description: Product description
          example: "Steam Voucher"
        overallDiscount:
          type: number
          description: Discount percentage
          example: 8
        image:
          type: string
          format: uri
          description: Product image URL
        status:
          type: string
          enum:
            - active
            - inactive
          example: "active"
        createdAt:
          type: integer
          description: Unix timestamp of creation
          example: 1750921573
        updatedAt:
          type: integer
          description: Unix timestamp of last update
          example: 1754384246
        assets:
          $ref: '#/components/schemas/GiftCardAssets'

    GiftCardAssets:
      type: object
      description: High-quality brand assets with S3 presigned URLs (expire after 15 minutes)
      properties:
        images:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                description: Image type
                enum:
                  - LOGOS
                example: "LOGOS"
              resolution:
                type: string
                description: Image resolution
                example: "512x512"
              url:
                type: string
                format: uri
                description: S3 presigned URL (expires in 15 minutes)
        documents:
          type: array
          items:
            type: object
            properties:
              documentType:
                type: string
                description: Document type
                enum:
                  - TERMS_AND_CONDITIONS
                  - STEPS_TO_REDEEM
              url:
                type: string
                format: uri
                description: S3 presigned URL for document
              text:
                type: array
                description: Parsed text content (for STEPS_TO_REDEEM)
                items:
                  type: string

    SkusResponse:
      type: object
      properties:
        skus:
          type: array
          items:
            $ref: '#/components/schemas/Sku'
        pagination:
          $ref: '#/components/schemas/Pagination'

    Sku:
      type: object
      properties:
        sku_id:
          type: string
          example: "2"
        name:
          type: string
          example: "STEAM 50"
        brand:
          type: string
          example: "Steam Voucher code"
        denomination:
          type: string
          description: Face value
          example: "50"
        tax_rate:
          type: string
          description: Tax rate percentage (GST)
          example: "18"
        discount:
          type: string
          description: Discount percentage
          example: "8%"
        status:
          type: string
          enum:
            - active
            - inactive
        createdAt:
          type: integer
        updateAt:
          type: integer

    PurchaseRequest:
      type: object
      required:
        - merchant_order_request_id
        - giftcard_id
        - sku_id
        - quantity
      properties:
        merchant_order_request_id:
          type: string
          description: Unique order ID / idempotency key
          example: "ORDER-2024-12345"
        giftcard_id:
          type: string
          description: Product ID
          example: "56"
        sku_id:
          type: string
          description: SKU ID
          example: "1001"
        quantity:
          type: integer
          description: Number of gift cards
          minimum: 1
          example: 2
        currency:
          type: string
          description: Currency code
          default: "INR"
          example: "INR"
        customerDetails:
          $ref: '#/components/schemas/CustomerDetails'
        deliveryDetails:
          $ref: '#/components/schemas/DeliveryDetails'
        customerDistributionChannels:
          type: array
          description: Auto-delivery methods
          items:
            type: string
            enum:
              - EMAIL
              - WHATSAPP
              - SMS
          example:
            - "EMAIL"

    CustomerDetails:
      type: object
      description: Customer information for invoice generation
      properties:
        name:
          type: string
          description: Customer full name
          example: "Rohan Sharma"
        email:
          type: string
          format: email
          description: Customer email
          example: "rohan.sharma@example.com"
        phone:
          type: string
          description: Indian phone number with +91 format
          pattern: '^\+91[0-9]{10}$'
          example: "+919876543210"
        address:
          $ref: '#/components/schemas/Address'

    Address:
      type: object
      properties:
        line1:
          type: string
          example: "123 MG Road"
        line2:
          type: string
          example: "Apt 4B"
        city:
          type: string
          example: "Mumbai"
        state:
          type: string
          example: "Maharashtra"
        postal_code:
          type: string
          example: "400001"
        country:
          type: string
          default: "India"
          example: "India"

    DeliveryDetails:
      type: object
      description: Recipient information for gift delivery
      properties:
        recipient_name:
          type: string
          description: Recipient full name
          example: "Priya Kumar"
        recipient_email:
          type: string
          format: email
          description: Recipient email
          example: "priya.kumar@example.com"
        recipient_phone:
          type: string
          description: Recipient phone number
          example: "+919876543211"
        wish_message:
          type: string
          description: Personal message (max 500 characters)
          maxLength: 500
          example: "Happy Birthday! Enjoy your gift!"

    PurchaseResponse:
      type: object
      properties:
        merchant_order_request_id:
          type: string
        order_id:
          type: string
          example: "567890"
        status:
          type: string
          enum:
            - completed
            - processing
            - failed
        encryptedgiftcodes:
          type: string
          description: AES-256-GCM encrypted gift codes
        iv:
          type: string
          description: Initialization vector for decryption
        tag:
          type: string
          description: Authentication tag for decryption
        senderName:
          type: string
          description: Customer name (from customerDetails)
        deliveryDetails:
          type: object
          properties:
            name:
              type: string
            phoneNumber:
              type: string
            email:
              type: string
        expiryDates:
          type: array
          description: Expiry dates for each gift card
          items:
            type: string
            format: date-time
        redeemlink:
          type: string
          format: uri
          description: URL for redeeming gift cards

    OrderResponse:
      type: object
      properties:
        merchant_order_request_id:
          type: string
        order_id:
          type: string
        status:
          type: string
          enum:
            - completed
            - processing
            - failed
        encryptedgiftcodes:
          type: string
        iv:
          type: string
        tag:
          type: string
        expiryDates:
          type: array
          items:
            type: string
            format: date-time
        redeemlink:
          type: string
          format: uri

    WalletBalanceResponse:
      type: object
      properties:
        balance:
          type: string
          example: "92883.95"
        partnerName:
          type: string
          example: "Acme Distribution Ltd"

    InvoiceResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        invoice_url:
          type: string
          format: uri
          description: S3 presigned URL (valid for 24 hours)
        invoice_number:
          type: string
          description: Sequential invoice number
          example: "INV-ACM-2024-00001"
        order_id:
          type: string
        generated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: URL expiration time

    Pagination:
      type: object
      properties:
        total:
          type: integer
          example: 2
        page:
          type: integer
          example: 0
        pageSize:
          type: integer
          example: 20
        totalPages:
          type: integer
          example: 1

    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            type:
              type: string
              enum:
                - authentication_error
                - invalid_request_error
                - api_error
            code:
              type: string
            message:
              type: string
            trace_id:
              type: string
            retryable:
              type: boolean
            fields:
              type: array
              items:
                type: object
                properties:
                  param:
                    type: string
                  code:
                    type: string
                  message:
                    type: string
            meta:
              type: object
              additionalProperties: true
            doc_url:
              type: string
